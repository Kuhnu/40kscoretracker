<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>40K Score Tracker</title>

    <!-- PWA / Add to Home Screen support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="40K Score">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#050505">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23111' width='100' height='100'/><text y='65' x='50' text-anchor='middle' font-size='40' fill='%23fff'>40K</text></svg>">
    <style>
        /* Orbitron font from jsDelivr CDN */
        @font-face {
            font-family: 'Orbitron';
            src: url('https://cdn.jsdelivr.net/fontsource/fonts/orbitron@latest/latin-700-normal.woff2') format('woff2');
            font-weight: 700;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Orbitron';
            src: url('https://cdn.jsdelivr.net/fontsource/fonts/orbitron@latest/latin-900-normal.woff2') format('woff2');
            font-weight: 900;
            font-style: normal;
            font-display: swap;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --attacker-color: #4A0808;
            --attacker-glow: #FF2D2D;
            --defender-color: #083D18;
            --defender-glow: #00FF44;
            --bg-color: #050505;
            --panel-color: #0A0A0A;
            --text-light: #FFFFFF;
            --text-dim: #444444;
        }

        body {
            font-family: 'Orbitron', 'Segoe UI', 'Arial Black', Arial, sans-serif;
            background-color: var(--bg-color);
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            user-select: none;
            overflow: hidden;
            position: relative;
        }

        /* Header with round counter */
        .header {
            background: linear-gradient(180deg, #151515 0%, var(--panel-color) 100%);
            padding: 8px 15px;
            padding-top: calc(8px + constant(safe-area-inset-top));
            padding-top: calc(8px + env(safe-area-inset-top, 0px));
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 30px rgba(0,0,0,0.8);
            position: relative;
            z-index: 10;
        }


        .round-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 40px;
            background: linear-gradient(180deg, #1A1A1A 0%, #0A0A0A 100%);
            box-shadow:
                inset 0 1px 0 rgba(255,255,255,0.1),
                inset 0 -1px 0 rgba(0,0,0,0.5),
                0 0 40px rgba(0,0,0,0.8);
            position: relative;
        }

        .round-clickable {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
        }

        .round-zone {
            flex: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.1s;
        }

        .round-zone:active {
            background: rgba(255, 255, 255, 0.1);
        }

        .round-zone-indicator {
            color: #444;
            font-size: 1.5rem;
            font-weight: 900;
            opacity: 0.5;
        }

        .round-zone:first-child .round-zone-indicator {
            margin-right: auto;
            padding-left: 10px;
        }

        .round-zone:last-child .round-zone-indicator {
            margin-left: auto;
            padding-right: 10px;
        }

        .round-label {
            color: #555;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 4px;
            z-index: 1;
            pointer-events: none;
        }

        .round-value {
            color: var(--text-light);
            font-size: 3rem;
            font-weight: 900;
            line-height: 1;
            text-shadow: 0 0 30px rgba(255,255,255,0.3);
            z-index: 1;
            pointer-events: none;
        }

        /* Main score area */
        .scores-container {
            display: flex;
            flex: 1;
            min-height: 0;
        }

        .player-side {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .defender-side {
            background:
                radial-gradient(ellipse at 0% 0%, rgba(0, 255, 68, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 0% 100%, rgba(0, 255, 68, 0.1) 0%, transparent 40%),
                linear-gradient(135deg, var(--defender-color) 0%, #020A04 100%);
            box-shadow: inset -30px 0 60px rgba(0, 0, 0, 0.5);
        }

        .attacker-side {
            background:
                radial-gradient(ellipse at 100% 0%, rgba(255, 45, 45, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 100% 100%, rgba(255, 45, 45, 0.1) 0%, transparent 40%),
                linear-gradient(225deg, var(--attacker-color) 0%, #0A0202 100%);
            box-shadow: inset 30px 0 60px rgba(0, 0, 0, 0.5);
        }

        /* Corner decorations */
        .player-side::before {
            content: '';
            position: absolute;
            top: 15px;
            width: 60px;
            height: 60px;
            border-width: 4px;
            border-style: solid;
            opacity: 0.4;
            pointer-events: none;
        }

        .defender-side::before {
            left: 15px;
            border-color: var(--defender-glow);
            border-right: none;
            border-bottom: none;
        }

        .attacker-side::before {
            right: 15px;
            border-color: var(--attacker-glow);
            border-left: none;
            border-bottom: none;
        }

        .player-side::after {
            content: '';
            position: absolute;
            bottom: 15px;
            width: 60px;
            height: 60px;
            border-width: 4px;
            border-style: solid;
            opacity: 0.4;
            pointer-events: none;
        }

        .defender-side::after {
            left: 15px;
            border-color: var(--defender-glow);
            border-right: none;
            border-top: none;
        }

        .attacker-side::after {
            right: 15px;
            border-color: var(--attacker-glow);
            border-left: none;
            border-top: none;
        }

        .score-section {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: pointer;
        }

        .score-section.vp-section {
            flex: 2;
        }

        .score-section.cp-section {
            flex: 1;
        }

        .score-label {
            font-size: 1.4rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 6px;
            position: absolute;
            top: 20px;
        }

        .defender-side .score-label {
            color: rgba(0, 255, 68, 0.5);
            text-shadow: 0 0 20px rgba(0, 255, 68, 0.3);
        }

        .attacker-side .score-label {
            color: rgba(255, 45, 45, 0.5);
            text-shadow: 0 0 20px rgba(255, 45, 45, 0.3);
        }

        .cp-section .score-label {
            font-size: 1.1rem;
            letter-spacing: 5px;
            top: 15px;
        }

        .score-clickable {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        .click-zone {
            flex: 1;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.1s;
        }

        .click-zone:active {
            background: rgba(255, 255, 255, 0.08);
        }

        .click-zone-indicator {
            font-size: 3rem;
            font-weight: 900;
            opacity: 0.1;
            pointer-events: none;
        }

        .defender-side .click-zone-indicator {
            color: var(--defender-glow);
        }

        .attacker-side .click-zone-indicator {
            color: var(--attacker-glow);
        }

        .click-zone.decrease .click-zone-indicator {
            margin-right: auto;
            padding-left: 25px;
        }

        .click-zone.increase .click-zone-indicator {
            margin-left: auto;
            padding-right: 25px;
        }

        .score-value {
            font-size: 22rem;
            font-weight: 900;
            color: var(--text-light);
            text-align: center;
            line-height: 0.85;
            pointer-events: none;
            z-index: 1;
        }

        .defender-side .score-value {
            text-shadow:
                0 0 80px rgba(0, 255, 68, 0.6),
                0 0 150px rgba(0, 255, 68, 0.3),
                0 5px 30px rgba(0, 0, 0, 0.5);
        }

        .attacker-side .score-value {
            text-shadow:
                0 0 80px rgba(255, 45, 45, 0.6),
                0 0 150px rgba(255, 45, 45, 0.3),
                0 5px 30px rgba(0, 0, 0, 0.5);
        }

        .cp-section .score-value {
            font-size: 12rem;
        }

        /* Footer */
        .footer {
            background: linear-gradient(0deg, #151515 0%, var(--panel-color) 100%);
            padding: 12px 0;
            padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
            display: flex;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.8);
            position: relative;
            z-index: 10;
        }

        .footer-btn {
            flex: 1;
            background: linear-gradient(180deg, #222 0%, #111 100%);
            color: #666;
            border: none;
            padding: 14px 20px;
            font-family: 'Orbitron', 'Segoe UI', 'Arial Black', Arial, sans-serif;
            font-size: 1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 3px;
            cursor: pointer;
            transition: all 0.1s ease;
            text-align: center;
        }

        .footer-btn {
            border-right: 1px solid #333;
        }

        .footer-btn:last-child {
            border-right: none;
        }

        /* Fullscreen button - corner positioned */
        .fullscreen-btn {
            position: fixed;
            bottom: calc(60px + env(safe-area-inset-bottom, 0px));
            right: 10px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(30, 30, 30, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.5rem;
            letter-spacing: 1px;
            z-index: 200;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            flex: none;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fullscreen-btn:active {
            background: rgba(60, 60, 60, 0.8);
            color: rgba(255, 255, 255, 0.8);
        }

        /* Tap indicators */
        .tap-indicator {
            position: absolute;
            font-size: 2.5rem;
            font-weight: 900;
            pointer-events: none;
            opacity: 0;
            left: 50%;
            bottom: 20px;
            transform: translateX(-50%);
            transition: all 0.4s ease-out;
            z-index: 50;
        }

        .tap-indicator.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .tap-indicator.fade {
            opacity: 0;
            transform: translateX(-50%) translateY(-20px);
        }

        .cp-section .tap-indicator {
            font-size: 2rem;
            bottom: 15px;
        }

        .defender-side .tap-indicator {
            color: var(--defender-glow);
            text-shadow: 0 0 20px var(--defender-glow);
        }

        .attacker-side .tap-indicator {
            color: var(--attacker-glow);
            text-shadow: 0 0 20px var(--attacker-glow);
        }

        /* Tap indicator centered */
        .tap-indicator.plus {
            color: #00FF44;
            text-shadow: 0 0 20px rgba(0, 255, 68, 0.8);
        }

        .tap-indicator.minus {
            color: #FF4444;
            text-shadow: 0 0 20px rgba(255, 68, 68, 0.8);
        }

        .footer-btn:active {
            background: linear-gradient(180deg, #333 0%, #222 100%);
            color: #999;
        }

        /* Confirmation Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: linear-gradient(180deg, #1A1A1A 0%, #0A0A0A 100%);
            padding: 40px 60px;
            text-align: center;
            box-shadow:
                0 0 100px rgba(0,0,0,0.9),
                inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .modal h2 {
            color: #888;
            font-size: 1.8rem;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 4px;
        }

        .modal-buttons {
            display: flex;
            gap: 25px;
            justify-content: center;
        }

        .modal-btn {
            font-family: 'Orbitron', 'Segoe UI', 'Arial Black', Arial, sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            padding: 18px 50px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 3px;
            border: none;
            transition: all 0.1s ease;
        }

        .modal-btn.confirm {
            background: linear-gradient(180deg, #5A0000 0%, #2A0000 100%);
            color: var(--attacker-glow);
            box-shadow:
                inset 0 1px 0 rgba(255,255,255,0.1),
                0 0 30px rgba(255, 45, 45, 0.3);
        }

        .modal-btn.confirm:active {
            background: linear-gradient(180deg, #7A0000 0%, #4A0000 100%);
            transform: scale(0.95);
        }

        .modal-btn.cancel {
            background: linear-gradient(180deg, #222 0%, #111 100%);
            color: #666;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .modal-btn.cancel:active {
            background: linear-gradient(180deg, #333 0%, #222 100%);
            color: #999;
            transform: scale(0.95);
        }

        /* History Modal */
        .history-modal {
            max-width: 90vw;
            max-height: 80vh;
            overflow: hidden;
        }

        .history-table-container {
            max-height: 50vh;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        .history-table th,
        .history-table td {
            padding: 8px 12px;
            text-align: center;
            border-bottom: 1px solid #333;
        }

        .history-table th {
            color: #888;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.7rem;
            position: sticky;
            top: 0;
            background: #1A1A1A;
        }

        .history-table td {
            color: #ccc;
        }

        .history-table .round-col {
            color: #888;
        }

        .history-table .defender-col {
            color: var(--defender-glow);
        }

        .history-table .attacker-col {
            color: var(--attacker-glow);
        }

        .history-table .delta-positive {
            color: #00FF44;
        }

        .history-table .delta-negative {
            color: #FF4444;
        }

        .history-empty {
            color: #666;
            padding: 30px;
            text-align: center;
        }

        /* Responsive - stack on mobile portrait */
        @media (max-width: 600px) {
            .header {
                position: absolute;
                top: 0;
                left: 50%;
                transform: translateX(-50%);
                padding: 3px 10px;
                padding-top: calc(3px + constant(safe-area-inset-top));
                padding-top: calc(3px + env(safe-area-inset-top, 0px));
                background: linear-gradient(180deg,
                    rgba(20,20,20,0.85) 0%,
                    rgba(10,10,10,0.8) 100%);
                border: 1px solid rgba(255,255,255,0.1);
                border-top: none;
                border-radius: 0 0 8px 8px;
                box-shadow: 0 3px 20px rgba(0,0,0,0.8);
                z-index: 100;
            }

            .round-container {
                padding: 2px 20px;
                background: transparent;
                box-shadow: none;
            }

            .round-label {
                font-size: 0.5rem;
                letter-spacing: 2px;
            }

            .round-value {
                font-size: 1.8rem;
            }

            .round-zone-indicator {
                font-size: 1rem;
                opacity: 0.4;
            }

            .scores-container {
                flex-direction: column;
                height: 100vh;
                height: 100dvh;
            }

            /* Defender first (top) in portrait */
            .defender-side {
                order: 1;
                box-shadow: inset 0 -30px 60px rgba(0, 0, 0, 0.5);
            }

            .attacker-side {
                order: 2;
                box-shadow: inset 0 30px 60px rgba(0, 0, 0, 0.5);
            }

            .player-side::before,
            .player-side::after {
                width: 25px;
                height: 25px;
                border-width: 3px;
            }

            .defender-side::before {
                top: 8px;
                left: 8px;
            }

            .defender-side::after {
                bottom: auto;
                top: 8px;
                left: auto;
                right: 8px;
                border-left: none;
                border-bottom: none;
                border-right: 3px solid var(--defender-glow);
                border-top: 3px solid var(--defender-glow);
            }

            .attacker-side::before {
                top: auto;
                bottom: 8px;
                right: auto;
                left: 8px;
                border-right: none;
                border-top: none;
                border-left: 3px solid var(--attacker-glow);
                border-bottom: 3px solid var(--attacker-glow);
            }

            .attacker-side::after {
                bottom: 8px;
                right: 8px;
            }

            .score-value {
                font-size: 8rem;
            }

            .cp-section .score-value {
                font-size: 5rem;
            }

            .click-zone-indicator {
                font-size: 1.5rem;
            }

            .score-label {
                font-size: 0.8rem;
                letter-spacing: 3px;
            }

            .cp-section .score-label {
                font-size: 0.7rem;
            }

            .footer {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                padding: 6px 0;
                padding-bottom: calc(6px + constant(safe-area-inset-bottom));
                padding-bottom: calc(6px + env(safe-area-inset-bottom, 0px));
                background: linear-gradient(0deg,
                    rgba(20,20,20,0.95) 0%,
                    rgba(10,10,10,0.9) 100%);
                border-top: 1px solid rgba(255,255,255,0.15);
                box-shadow: 0 -3px 20px rgba(0,0,0,0.8);
                z-index: 100;
            }

            .footer-btn {
                padding: 8px 6px;
                font-size: 0.6rem;
                letter-spacing: 1px;
                background: transparent;
            }

            /* VP labels - both need clearance since either can be on top after switch */
            .vp-section .score-label {
                top: 55px;
            }

            /* CP labels */
            .cp-section .score-label {
                top: 8px;
            }

            /* Tap indicators in middle of sections */
            .vp-section .tap-indicator {
                top: auto !important;
                bottom: 15% !important;
                font-size: 1.4rem;
            }

            .cp-section .tap-indicator {
                top: auto !important;
                bottom: 10% !important;
                font-size: 1.1rem;
            }
        }

        @media (max-width: 400px) {
            .round-container {
                padding: 4px 25px;
            }

            .round-value {
                font-size: 2rem;
            }

            .round-zone-indicator {
                font-size: 1rem;
            }

            .score-value {
                font-size: 7rem;
            }

            .cp-section .score-value {
                font-size: 4.5rem;
            }

            .score-label {
                font-size: 0.7rem;
                letter-spacing: 3px;
                top: 10px;
            }

            .cp-section .score-label {
                font-size: 0.6rem;
                top: 8px;
            }
        }

        /* Landscape mode on mobile - short viewport */
        @media (max-height: 500px) and (orientation: landscape) {
            .header {
                position: absolute;
                top: 0;
                left: 50%;
                transform: translateX(-50%);
                padding: 0;
                background: linear-gradient(180deg,
                    rgba(20,20,20,0.9) 0%,
                    rgba(10,10,10,0.85) 100%);
                border: 1px solid rgba(255,255,255,0.1);
                border-top: none;
                border-radius: 0 0 8px 8px;
                box-shadow: 0 3px 20px rgba(0,0,0,0.8);
                z-index: 100;
            }

            .round-container {
                padding: 3px 25px;
                background: linear-gradient(180deg,
                    rgba(25,25,25,0.95) 0%,
                    rgba(10,10,10,0.95) 100%);
            }

            .round-label {
                font-size: 0.5rem;
                letter-spacing: 2px;
            }

            .round-value {
                font-size: 2.2rem;
            }

            .round-zone-indicator {
                font-size: 1rem;
                opacity: 0.3;
            }

            .scores-container {
                height: 100vh;
                height: 100dvh;
            }

            .score-value {
                font-size: 9rem;
            }

            .cp-section .score-value {
                font-size: 6rem;
            }

            .score-label {
                font-size: 0.7rem;
                top: 5px;
                letter-spacing: 2px;
            }

            .cp-section .score-label {
                font-size: 0.6rem;
                top: 3px;
            }

            /* Push scores to top, leave room for tap indicators at bottom */
            .vp-section {
                justify-content: flex-start;
                padding-top: 20px;
            }

            .cp-section {
                padding-bottom: 30px;
                justify-content: flex-start;
                padding-top: 20px;
            }

            .click-zone-indicator {
                font-size: 1.8rem;
                opacity: 0.06;
            }

            .player-side::before,
            .player-side::after {
                width: 20px;
                height: 20px;
                border-width: 2px;
                top: 5px;
            }

            .defender-side::before { left: 5px; }
            .attacker-side::before { right: 5px; }

            .defender-side::after,
            .attacker-side::after {
                bottom: 35px;
            }

            .defender-side::after { left: 5px; }
            .attacker-side::after { right: 5px; }

            .footer {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                padding: 0;
                background: linear-gradient(0deg,
                    rgba(20,20,20,0.9) 0%,
                    rgba(10,10,10,0.85) 100%);
                border-top: 1px solid rgba(255,255,255,0.1);
                box-shadow: 0 -3px 20px rgba(0,0,0,0.8);
                z-index: 100;
            }

            .footer-btn {
                padding: 6px 8px;
                font-size: 0.6rem;
                letter-spacing: 1px;
                background: transparent;
                box-shadow: none;
                border-right: 1px solid rgba(255,255,255,0.1);
            }

            .footer-btn:last-child {
                border-right: none;
            }

            /* Tap indicators closer to numbers in landscape */
            .vp-section .tap-indicator {
                top: auto !important;
                bottom: 25% !important;
                font-size: 1.3rem;
            }

            .cp-section .tap-indicator {
                top: auto !important;
                bottom: 20% !important;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="round-container">
            <span class="round-label">Round</span>
            <span class="round-value" id="round">1</span>
            <div class="round-clickable">
                <div class="round-zone" onclick="changeRound(-1)">
                    <span class="round-zone-indicator">&lt;</span>
                </div>
                <div class="round-zone" onclick="changeRound(1)">
                    <span class="round-zone-indicator">&gt;</span>
                </div>
            </div>
        </div>
    </header>

    <main class="scores-container">
        <section class="player-side defender-side" id="defender-side">
            <div class="score-section vp-section">
                <span class="score-label">Defender VP</span>
                <span class="score-value" id="defender-vp">0</span>
                <div class="score-clickable">
                    <div class="click-zone decrease" onclick="changeScore('defender', 'vp', -1)">
                        <span class="click-zone-indicator">&lt;</span>
                    </div>
                    <div class="click-zone increase" onclick="changeScore('defender', 'vp', 1)">
                        <span class="click-zone-indicator">&gt;</span>
                    </div>
                </div>
            </div>
            <div class="score-section cp-section">
                <span class="score-label">Defender CP</span>
                <span class="score-value" id="defender-cp">0</span>
                <div class="score-clickable">
                    <div class="click-zone decrease" onclick="changeScore('defender', 'cp', -1)">
                        <span class="click-zone-indicator">&lt;</span>
                    </div>
                    <div class="click-zone increase" onclick="changeScore('defender', 'cp', 1)">
                        <span class="click-zone-indicator">&gt;</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="player-side attacker-side" id="attacker-side">
            <div class="score-section vp-section">
                <span class="score-label">Attacker VP</span>
                <span class="score-value" id="attacker-vp">0</span>
                <div class="score-clickable">
                    <div class="click-zone decrease" onclick="changeScore('attacker', 'vp', -1)">
                        <span class="click-zone-indicator">&lt;</span>
                    </div>
                    <div class="click-zone increase" onclick="changeScore('attacker', 'vp', 1)">
                        <span class="click-zone-indicator">&gt;</span>
                    </div>
                </div>
            </div>
            <div class="score-section cp-section">
                <span class="score-label">Attacker CP</span>
                <span class="score-value" id="attacker-cp">0</span>
                <div class="score-clickable">
                    <div class="click-zone decrease" onclick="changeScore('attacker', 'cp', -1)">
                        <span class="click-zone-indicator">&lt;</span>
                    </div>
                    <div class="click-zone increase" onclick="changeScore('attacker', 'cp', 1)">
                        <span class="click-zone-indicator">&gt;</span>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <button class="footer-btn" onclick="switchSides()">Switch Sides</button>
        <button class="footer-btn" onclick="showHistory()">Round History</button>
        <button class="footer-btn" onclick="showResetConfirm()">Reset</button>
    </footer>

    <!-- Fullscreen button -->
    <button class="fullscreen-btn" onclick="toggleFullscreen()">FS</button>

    <!-- Reset Confirmation Modal -->
    <div class="modal-overlay" id="resetModal">
        <div class="modal">
            <h2>Reset Game?</h2>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="hideResetConfirm()">Cancel</button>
                <button class="modal-btn confirm" onclick="confirmReset()">Reset</button>
            </div>
        </div>
    </div>

    <!-- iOS Fullscreen Instructions Modal -->
    <div class="modal-overlay" id="iosModal">
        <div class="modal">
            <h2>Fullscreen on iOS</h2>
            <p style="color: #888; margin-bottom: 20px; font-size: 0.9rem; line-height: 1.5;">
                iOS doesn't support fullscreen.<br>
                To get fullscreen, add this app to your home screen:
            </p>
            <ol style="color: #aaa; text-align: left; font-size: 0.8rem; line-height: 1.8; margin-bottom: 25px;">
                <li>Tap the Share button (square with arrow)</li>
                <li>Scroll down and tap "Add to Home Screen"</li>
                <li>Tap "Add"</li>
                <li>Open the app from your home screen</li>
            </ol>
            <button class="modal-btn cancel" onclick="hideIosModal()">OK</button>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal-overlay" id="historyModal" onclick="hideHistory()">
        <div class="modal history-modal" onclick="event.stopPropagation()">
            <h2>Round History</h2>
            <div class="history-table-container" id="historyContent">
                <!-- Populated by JavaScript -->
            </div>
            <button class="modal-btn cancel" onclick="hideHistory()">Close</button>
        </div>
    </div>

    <script>
        // Game state
        let state = {
            attacker: { vp: 0, cp: 0 },
            defender: { vp: 0, cp: 0 },
            round: 1,
            switched: false,
            history: [],
            lastRecordedRound: 0
        };

        // Load state from localStorage
        function loadState() {
            const saved = localStorage.getItem('40k-score-tracker');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // Merge with defaults to handle missing fields from old saves
                    state = {
                        attacker: parsed.attacker || { vp: 0, cp: 0 },
                        defender: parsed.defender || { vp: 0, cp: 0 },
                        round: parsed.round || 1,
                        switched: parsed.switched || false,
                        history: parsed.history || [],
                        lastRecordedRound: parsed.lastRecordedRound || 0
                    };
                } catch (e) {
                    console.log('Could not load saved state');
                }
            }
        }

        // Save state to localStorage
        function saveState() {
            localStorage.setItem('40k-score-tracker', JSON.stringify(state));
        }

        // Haptic feedback
        function vibrate() {
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        // Update display
        function updateDisplay() {
            document.getElementById('attacker-vp').textContent = state.attacker.vp;
            document.getElementById('attacker-cp').textContent = state.attacker.cp;
            document.getElementById('defender-vp').textContent = state.defender.vp;
            document.getElementById('defender-cp').textContent = state.defender.cp;
            document.getElementById('round').textContent = state.round;

            // Apply switched state
            const defenderSide = document.getElementById('defender-side');
            const attackerSide = document.getElementById('attacker-side');
            if (state.switched) {
                defenderSide.style.order = '2';
                attackerSide.style.order = '1';
            } else {
                defenderSide.style.order = '1';
                attackerSide.style.order = '2';
            }

            saveState();
        }

        // Track combined presses per player/type
        const tapTrackers = {};

        // Show tap indicator with combined +/- counting
        function showTapIndicator(player, type, delta) {
            const key = `${player}-${type}`;
            const section = document.querySelector(`#${player}-side .${type}-section`);

            // Check if there's an active indicator for this key
            if (tapTrackers[key] && tapTrackers[key].active) {
                // Update existing indicator with combined count
                tapTrackers[key].count += delta;
                const indicator = tapTrackers[key].element;

                // Update display
                if (tapTrackers[key].count === 0) {
                    indicator.textContent = '0';
                    indicator.className = 'tap-indicator show';
                } else if (tapTrackers[key].count > 0) {
                    indicator.textContent = `+${tapTrackers[key].count}`;
                    indicator.className = 'tap-indicator plus show';
                } else {
                    indicator.textContent = `${tapTrackers[key].count}`;
                    indicator.className = 'tap-indicator minus show';
                }

                // Reset the fade timer
                clearTimeout(tapTrackers[key].fadeTimer);
                clearTimeout(tapTrackers[key].removeTimer);

                tapTrackers[key].fadeTimer = setTimeout(() => {
                    indicator.classList.add('fade');
                    tapTrackers[key].removeTimer = setTimeout(() => {
                        indicator.remove();
                        tapTrackers[key].active = false;
                    }, 400);
                }, 1200);
            } else {
                // Create new indicator
                const indicator = document.createElement('div');
                indicator.className = `tap-indicator ${delta > 0 ? 'plus' : 'minus'}`;
                indicator.textContent = delta > 0 ? `+1` : `-1`;
                section.appendChild(indicator);

                tapTrackers[key] = {
                    active: true,
                    count: delta,
                    element: indicator,
                    fadeTimer: null,
                    removeTimer: null
                };

                // Trigger animation
                requestAnimationFrame(() => {
                    indicator.classList.add('show');
                    tapTrackers[key].fadeTimer = setTimeout(() => {
                        indicator.classList.add('fade');
                        tapTrackers[key].removeTimer = setTimeout(() => {
                            indicator.remove();
                            tapTrackers[key].active = false;
                        }, 400);
                    }, 1200);
                });
            }
        }

        // Change score
        function changeScore(player, type, delta) {
            vibrate();
            state[player][type] += delta;
            showTapIndicator(player, type, delta);
            updateDisplay();
        }

        // Record current scores for the round
        function recordRoundHistory() {
            const currentRound = state.round;

            // Find or create entry for this round
            let roundEntry = state.history.find(h => h.round === currentRound);

            if (!roundEntry) {
                // Get previous totals
                const prevEntry = state.history.find(h => h.round === currentRound - 1);
                const prevDefVP = prevEntry ? prevEntry.defender.vp : 0;
                const prevDefCP = prevEntry ? prevEntry.defender.cp : 0;
                const prevAtkVP = prevEntry ? prevEntry.attacker.vp : 0;
                const prevAtkCP = prevEntry ? prevEntry.attacker.cp : 0;

                roundEntry = {
                    round: currentRound,
                    defender: {
                        vp: state.defender.vp,
                        cp: state.defender.cp,
                        vpDelta: state.defender.vp - prevDefVP,
                        cpDelta: state.defender.cp - prevDefCP
                    },
                    attacker: {
                        vp: state.attacker.vp,
                        cp: state.attacker.cp,
                        vpDelta: state.attacker.vp - prevAtkVP,
                        cpDelta: state.attacker.cp - prevAtkCP
                    }
                };
                state.history.push(roundEntry);
            } else {
                // Update existing entry
                const prevEntry = state.history.find(h => h.round === currentRound - 1);
                const prevDefVP = prevEntry ? prevEntry.defender.vp : 0;
                const prevDefCP = prevEntry ? prevEntry.defender.cp : 0;
                const prevAtkVP = prevEntry ? prevEntry.attacker.vp : 0;
                const prevAtkCP = prevEntry ? prevEntry.attacker.cp : 0;

                roundEntry.defender.vp = state.defender.vp;
                roundEntry.defender.cp = state.defender.cp;
                roundEntry.defender.vpDelta = state.defender.vp - prevDefVP;
                roundEntry.defender.cpDelta = state.defender.cp - prevDefCP;
                roundEntry.attacker.vp = state.attacker.vp;
                roundEntry.attacker.cp = state.attacker.cp;
                roundEntry.attacker.vpDelta = state.attacker.vp - prevAtkVP;
                roundEntry.attacker.cpDelta = state.attacker.cp - prevAtkCP;
            }
        }

        // Change round
        function changeRound(delta) {
            vibrate();
            const newRound = state.round + delta;
            if (newRound >= 1) {
                // Record current round before changing
                recordRoundHistory();
                state.round = newRound;
                updateDisplay();
            }
        }

        // Show reset confirmation
        function showResetConfirm() {
            vibrate();
            document.getElementById('resetModal').classList.add('active');
        }

        // Hide reset confirmation
        function hideResetConfirm() {
            vibrate();
            document.getElementById('resetModal').classList.remove('active');
        }

        // Confirm reset
        function confirmReset() {
            vibrate();
            state.attacker.vp = 0;
            state.attacker.cp = 0;
            state.defender.vp = 0;
            state.defender.cp = 0;
            state.round = 1;
            state.switched = false;
            state.history = [];
            updateDisplay();
            hideResetConfirm();
        }

        // Show history modal
        function showHistory() {
            vibrate();
            // Record current round first
            recordRoundHistory();
            renderHistory();
            document.getElementById('historyModal').classList.add('active');
        }

        // Hide history modal
        function hideHistory() {
            vibrate();
            document.getElementById('historyModal').classList.remove('active');
        }

        // Render history table
        function renderHistory() {
            const container = document.getElementById('historyContent');

            if (state.history.length === 0) {
                container.innerHTML = '<div class="history-empty">No history yet.<br>Advance rounds to record scores.</div>';
                return;
            }

            const formatDelta = (delta) => {
                if (delta > 0) return `+${delta}`;
                if (delta < 0) return `${delta}`;
                return '0';
            };

            let html = `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>R</th>
                            <th class="defender-col">Defender</th>
                            <th class="attacker-col">Attacker</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            state.history.sort((a, b) => a.round - b.round).forEach(entry => {
                const defDeltaClass = entry.defender.vpDelta > 0 ? 'delta-positive' : (entry.defender.vpDelta < 0 ? 'delta-negative' : '');
                const atkDeltaClass = entry.attacker.vpDelta > 0 ? 'delta-positive' : (entry.attacker.vpDelta < 0 ? 'delta-negative' : '');

                html += `
                    <tr>
                        <td class="round-col">${entry.round}</td>
                        <td><span class="${defDeltaClass}">${formatDelta(entry.defender.vpDelta)}</span> <small>(${entry.defender.vp})</small></td>
                        <td><span class="${atkDeltaClass}">${formatDelta(entry.attacker.vpDelta)}</span> <small>(${entry.attacker.vp})</small></td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Switch sides (swap positions)
        function switchSides() {
            vibrate();
            state.switched = !state.switched;
            updateDisplay();
        }

        // Detect iOS
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
            (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

        // Check if running as standalone PWA
        const isStandalone = window.navigator.standalone ||
            window.matchMedia('(display-mode: standalone)').matches;

        // Show iOS modal
        function showIosModal() {
            document.getElementById('iosModal').classList.add('active');
        }

        // Hide iOS modal
        function hideIosModal() {
            vibrate();
            document.getElementById('iosModal').classList.remove('active');
        }

        // Toggle fullscreen
        function toggleFullscreen() {
            vibrate();

            // If iOS and not standalone, show instructions
            if (isIOS && !isStandalone) {
                showIosModal();
                return;
            }

            // If already standalone on iOS, hide the button
            if (isIOS && isStandalone) {
                return;
            }

            const elem = document.documentElement;

            const isFullscreen = document.fullscreenElement ||
                document.webkitFullscreenElement ||
                document.mozFullScreenElement ||
                document.msFullscreenElement;

            if (!isFullscreen) {
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.mozRequestFullScreen) {
                    elem.mozRequestFullScreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        }

        // Hide fullscreen button if already in standalone mode
        if (isStandalone) {
            document.querySelector('.fullscreen-btn').style.display = 'none';
        }

        // Update fullscreen button text
        function updateFullscreenBtn() {
            const btn = document.querySelector('.fullscreen-btn');
            const isFullscreen = document.fullscreenElement ||
                document.webkitFullscreenElement ||
                document.mozFullScreenElement ||
                document.msFullscreenElement;
            if (btn) {
                btn.textContent = isFullscreen ? 'X' : 'FS';
            }
        }

        document.addEventListener('fullscreenchange', updateFullscreenBtn);
        document.addEventListener('webkitfullscreenchange', updateFullscreenBtn);
        document.addEventListener('mozfullscreenchange', updateFullscreenBtn);
        document.addEventListener('MSFullscreenChange', updateFullscreenBtn);

        // Initialize
        loadState();
        updateDisplay();
    </script>
</body>
</html>
