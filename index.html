<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>40K Score Tracker</title>

    <!-- PWA / Add to Home Screen support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="40K Score">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#050505">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23111' width='100' height='100'/><text y='65' x='50' text-anchor='middle' font-size='40' fill='%23fff'>40K</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --attacker-color: #4A0808;
            --attacker-glow: #FF2D2D;
            --defender-color: #083D18;
            --defender-glow: #00FF44;
            --bg-color: #050505;
            --panel-color: #0A0A0A;
            --text-light: #FFFFFF;
            --text-dim: #444444;
        }

        body {
            font-family: 'Orbitron', sans-serif;
            background-color: var(--bg-color);
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            user-select: none;
            overflow: hidden;
            position: relative;
        }

        /* Header with round counter */
        .header {
            background: linear-gradient(180deg, #151515 0%, var(--panel-color) 100%);
            padding: 8px 15px;
            padding-top: calc(8px + constant(safe-area-inset-top));
            padding-top: calc(8px + env(safe-area-inset-top, 0px));
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 30px rgba(0,0,0,0.8);
            position: relative;
            z-index: 10;
        }


        .round-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 40px;
            background: linear-gradient(180deg, #1A1A1A 0%, #0A0A0A 100%);
            box-shadow:
                inset 0 1px 0 rgba(255,255,255,0.1),
                inset 0 -1px 0 rgba(0,0,0,0.5),
                0 0 40px rgba(0,0,0,0.8);
            position: relative;
        }

        .round-clickable {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
        }

        .round-zone {
            flex: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.1s;
        }

        .round-zone:active {
            background: rgba(255, 255, 255, 0.1);
        }

        .round-zone-indicator {
            color: #444;
            font-size: 1.5rem;
            font-weight: 900;
            opacity: 0.5;
        }

        .round-zone:first-child .round-zone-indicator {
            margin-right: auto;
            padding-left: 10px;
        }

        .round-zone:last-child .round-zone-indicator {
            margin-left: auto;
            padding-right: 10px;
        }

        .round-label {
            color: #555;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 4px;
            z-index: 1;
            pointer-events: none;
        }

        .round-value {
            color: var(--text-light);
            font-size: 3rem;
            font-weight: 900;
            line-height: 1;
            text-shadow: 0 0 30px rgba(255,255,255,0.3);
            z-index: 1;
            pointer-events: none;
        }

        /* Main score area */
        .scores-container {
            display: flex;
            flex: 1;
            min-height: 0;
        }

        .player-side {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .defender-side {
            background:
                radial-gradient(ellipse at 0% 0%, rgba(0, 255, 68, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 0% 100%, rgba(0, 255, 68, 0.1) 0%, transparent 40%),
                linear-gradient(135deg, var(--defender-color) 0%, #020A04 100%);
            box-shadow: inset -30px 0 60px rgba(0, 0, 0, 0.5);
        }

        .attacker-side {
            background:
                radial-gradient(ellipse at 100% 0%, rgba(255, 45, 45, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 100% 100%, rgba(255, 45, 45, 0.1) 0%, transparent 40%),
                linear-gradient(225deg, var(--attacker-color) 0%, #0A0202 100%);
            box-shadow: inset 30px 0 60px rgba(0, 0, 0, 0.5);
        }

        /* Corner decorations */
        .player-side::before {
            content: '';
            position: absolute;
            top: 15px;
            width: 60px;
            height: 60px;
            border-width: 4px;
            border-style: solid;
            opacity: 0.4;
            pointer-events: none;
        }

        .defender-side::before {
            left: 15px;
            border-color: var(--defender-glow);
            border-right: none;
            border-bottom: none;
        }

        .attacker-side::before {
            right: 15px;
            border-color: var(--attacker-glow);
            border-left: none;
            border-bottom: none;
        }

        .player-side::after {
            content: '';
            position: absolute;
            bottom: 15px;
            width: 60px;
            height: 60px;
            border-width: 4px;
            border-style: solid;
            opacity: 0.4;
            pointer-events: none;
        }

        .defender-side::after {
            left: 15px;
            border-color: var(--defender-glow);
            border-right: none;
            border-top: none;
        }

        .attacker-side::after {
            right: 15px;
            border-color: var(--attacker-glow);
            border-left: none;
            border-top: none;
        }

        .score-section {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: pointer;
        }

        .score-section.vp-section {
            flex: 2;
        }

        .score-section.cp-section {
            flex: 1;
        }

        .score-label {
            font-size: 1.4rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 6px;
            position: absolute;
            top: 20px;
        }

        .defender-side .score-label {
            color: rgba(0, 255, 68, 0.5);
            text-shadow: 0 0 20px rgba(0, 255, 68, 0.3);
        }

        .attacker-side .score-label {
            color: rgba(255, 45, 45, 0.5);
            text-shadow: 0 0 20px rgba(255, 45, 45, 0.3);
        }

        .cp-section .score-label {
            font-size: 1.1rem;
            letter-spacing: 5px;
            top: 15px;
        }

        .score-clickable {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        .click-zone {
            flex: 1;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.1s;
        }

        .click-zone:active {
            background: rgba(255, 255, 255, 0.08);
        }

        .click-zone-indicator {
            font-size: 3rem;
            font-weight: 900;
            opacity: 0.1;
            pointer-events: none;
        }

        .defender-side .click-zone-indicator {
            color: var(--defender-glow);
        }

        .attacker-side .click-zone-indicator {
            color: var(--attacker-glow);
        }

        .click-zone.decrease .click-zone-indicator {
            margin-right: auto;
            padding-left: 25px;
        }

        .click-zone.increase .click-zone-indicator {
            margin-left: auto;
            padding-right: 25px;
        }

        .score-value {
            font-size: 22rem;
            font-weight: 900;
            color: var(--text-light);
            text-align: center;
            line-height: 0.85;
            pointer-events: none;
            z-index: 1;
        }

        .defender-side .score-value {
            text-shadow:
                0 0 80px rgba(0, 255, 68, 0.6),
                0 0 150px rgba(0, 255, 68, 0.3),
                0 5px 30px rgba(0, 0, 0, 0.5);
        }

        .attacker-side .score-value {
            text-shadow:
                0 0 80px rgba(255, 45, 45, 0.6),
                0 0 150px rgba(255, 45, 45, 0.3),
                0 5px 30px rgba(0, 0, 0, 0.5);
        }

        .cp-section .score-value {
            font-size: 12rem;
        }

        /* Footer */
        .footer {
            background: linear-gradient(0deg, #151515 0%, var(--panel-color) 100%);
            padding: 12px 0;
            padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
            display: flex;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.8);
            position: relative;
            z-index: 10;
        }

        .footer-btn {
            flex: 1;
            background: linear-gradient(180deg, #222 0%, #111 100%);
            color: #666;
            border: none;
            padding: 14px 20px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 3px;
            cursor: pointer;
            transition: all 0.1s ease;
            text-align: center;
        }

        .footer-btn {
            border-right: 1px solid #333;
        }

        .footer-btn:last-child {
            border-right: none;
        }

        /* Fullscreen button - corner positioned */
        .fullscreen-btn {
            position: fixed;
            bottom: calc(60px + env(safe-area-inset-bottom, 0px));
            right: 10px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(30, 30, 30, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.5rem;
            letter-spacing: 1px;
            z-index: 200;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            flex: none;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fullscreen-btn:active {
            background: rgba(60, 60, 60, 0.8);
            color: rgba(255, 255, 255, 0.8);
        }

        /* Tap indicators */
        .tap-indicator {
            position: absolute;
            font-size: 2rem;
            font-weight: 900;
            pointer-events: none;
            opacity: 0;
            transform: translateY(0);
            transition: all 0.4s ease-out;
            z-index: 50;
        }

        .tap-indicator.show {
            opacity: 1;
            transform: translateY(-20px);
        }

        .tap-indicator.fade {
            opacity: 0;
            transform: translateY(-40px);
        }

        .defender-side .tap-indicator {
            color: var(--defender-glow);
            text-shadow: 0 0 20px var(--defender-glow);
        }

        .attacker-side .tap-indicator {
            color: var(--attacker-glow);
            text-shadow: 0 0 20px var(--attacker-glow);
        }

        /* Position +/- indicators on opposite sides */
        .tap-indicator.plus {
            left: 65% !important;
        }

        .tap-indicator.minus {
            left: 35% !important;
        }

        .footer-btn:active {
            background: linear-gradient(180deg, #333 0%, #222 100%);
            color: #999;
        }

        /* Confirmation Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: linear-gradient(180deg, #1A1A1A 0%, #0A0A0A 100%);
            padding: 40px 60px;
            text-align: center;
            box-shadow:
                0 0 100px rgba(0,0,0,0.9),
                inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .modal h2 {
            color: #888;
            font-size: 1.8rem;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 4px;
        }

        .modal-buttons {
            display: flex;
            gap: 25px;
            justify-content: center;
        }

        .modal-btn {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            padding: 18px 50px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 3px;
            border: none;
            transition: all 0.1s ease;
        }

        .modal-btn.confirm {
            background: linear-gradient(180deg, #5A0000 0%, #2A0000 100%);
            color: var(--attacker-glow);
            box-shadow:
                inset 0 1px 0 rgba(255,255,255,0.1),
                0 0 30px rgba(255, 45, 45, 0.3);
        }

        .modal-btn.confirm:active {
            background: linear-gradient(180deg, #7A0000 0%, #4A0000 100%);
            transform: scale(0.95);
        }

        .modal-btn.cancel {
            background: linear-gradient(180deg, #222 0%, #111 100%);
            color: #666;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .modal-btn.cancel:active {
            background: linear-gradient(180deg, #333 0%, #222 100%);
            color: #999;
            transform: scale(0.95);
        }

        /* Responsive - stack on mobile portrait */
        @media (max-width: 600px) {
            .header {
                position: absolute;
                top: 0;
                left: 50%;
                transform: translateX(-50%);
                padding: 3px 10px;
                padding-top: calc(3px + constant(safe-area-inset-top));
                padding-top: calc(3px + env(safe-area-inset-top, 0px));
                background: linear-gradient(180deg,
                    rgba(20,20,20,0.85) 0%,
                    rgba(10,10,10,0.8) 100%);
                border: 1px solid rgba(255,255,255,0.1);
                border-top: none;
                border-radius: 0 0 8px 8px;
                box-shadow: 0 3px 20px rgba(0,0,0,0.8);
                z-index: 100;
            }

            .round-container {
                padding: 2px 20px;
                background: transparent;
                box-shadow: none;
            }

            .round-label {
                font-size: 0.5rem;
                letter-spacing: 2px;
            }

            .round-value {
                font-size: 1.8rem;
            }

            .round-zone-indicator {
                font-size: 1rem;
                opacity: 0.4;
            }

            .scores-container {
                flex-direction: column;
                height: 100vh;
                height: 100dvh;
            }

            /* Defender first (top) in portrait */
            .defender-side {
                order: 1;
                box-shadow: inset 0 -30px 60px rgba(0, 0, 0, 0.5);
            }

            .attacker-side {
                order: 2;
                box-shadow: inset 0 30px 60px rgba(0, 0, 0, 0.5);
            }

            .player-side::before,
            .player-side::after {
                width: 25px;
                height: 25px;
                border-width: 3px;
            }

            .defender-side::before {
                top: 8px;
                left: 8px;
            }

            .defender-side::after {
                bottom: auto;
                top: 8px;
                left: auto;
                right: 8px;
                border-left: none;
                border-bottom: none;
                border-right: 3px solid var(--defender-glow);
                border-top: 3px solid var(--defender-glow);
            }

            .attacker-side::before {
                top: auto;
                bottom: 8px;
                right: auto;
                left: 8px;
                border-right: none;
                border-top: none;
                border-left: 3px solid var(--attacker-glow);
                border-bottom: 3px solid var(--attacker-glow);
            }

            .attacker-side::after {
                bottom: 8px;
                right: 8px;
            }

            .score-value {
                font-size: 8rem;
            }

            .cp-section .score-value {
                font-size: 5rem;
            }

            .click-zone-indicator {
                font-size: 1.5rem;
            }

            .score-label {
                font-size: 0.8rem;
                letter-spacing: 3px;
            }

            .cp-section .score-label {
                font-size: 0.7rem;
            }

            .footer {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                padding: 8px 0;
                padding-bottom: calc(8px + constant(safe-area-inset-bottom));
                padding-bottom: calc(8px + env(safe-area-inset-bottom, 0px));
                background: linear-gradient(0deg,
                    rgba(20,20,20,0.9) 0%,
                    rgba(10,10,10,0.85) 100%);
                border-top: 1px solid rgba(255,255,255,0.1);
                box-shadow: 0 -3px 20px rgba(0,0,0,0.8);
                z-index: 100;
            }

            .footer-btn {
                padding: 10px 8px;
                font-size: 0.7rem;
                letter-spacing: 1px;
                background: transparent;
            }

            /* Tap indicators positioned left/right */
            .tap-indicator.plus {
                left: 70% !important;
            }

            .tap-indicator.minus {
                left: 30% !important;
            }
        }

        @media (max-width: 400px) {
            .round-container {
                padding: 4px 25px;
            }

            .round-value {
                font-size: 2rem;
            }

            .round-zone-indicator {
                font-size: 1rem;
            }

            .score-value {
                font-size: 7rem;
            }

            .cp-section .score-value {
                font-size: 4.5rem;
            }

            .score-label {
                font-size: 0.7rem;
                letter-spacing: 3px;
                top: 10px;
            }

            .cp-section .score-label {
                font-size: 0.6rem;
                top: 8px;
            }
        }

        /* Landscape mode on mobile - short viewport */
        @media (max-height: 500px) and (orientation: landscape) {
            .header {
                position: absolute;
                top: 0;
                left: 50%;
                transform: translateX(-50%);
                padding: 0;
                background: linear-gradient(180deg,
                    rgba(20,20,20,0.9) 0%,
                    rgba(10,10,10,0.85) 100%);
                border: 1px solid rgba(255,255,255,0.1);
                border-top: none;
                border-radius: 0 0 8px 8px;
                box-shadow: 0 3px 20px rgba(0,0,0,0.8);
                z-index: 100;
            }

            .round-container {
                padding: 3px 25px;
                background: linear-gradient(180deg,
                    rgba(25,25,25,0.95) 0%,
                    rgba(10,10,10,0.95) 100%);
            }

            .round-label {
                font-size: 0.5rem;
                letter-spacing: 2px;
            }

            .round-value {
                font-size: 2.2rem;
            }

            .round-zone-indicator {
                font-size: 1rem;
                opacity: 0.3;
            }

            .scores-container {
                height: 100vh;
                height: 100dvh;
            }

            .score-value {
                font-size: 9rem;
            }

            .cp-section .score-value {
                font-size: 6rem;
            }

            .score-label {
                font-size: 0.7rem;
                top: 5px;
                letter-spacing: 2px;
            }

            .cp-section .score-label {
                font-size: 0.6rem;
                top: 3px;
            }

            .cp-section {
                padding-bottom: 30px;
                justify-content: flex-start;
                padding-top: 25px;
            }

            .click-zone-indicator {
                font-size: 1.8rem;
                opacity: 0.06;
            }

            .player-side::before,
            .player-side::after {
                width: 20px;
                height: 20px;
                border-width: 2px;
                top: 5px;
            }

            .defender-side::before { left: 5px; }
            .attacker-side::before { right: 5px; }

            .defender-side::after,
            .attacker-side::after {
                bottom: 35px;
            }

            .defender-side::after { left: 5px; }
            .attacker-side::after { right: 5px; }

            .footer {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                padding: 0;
                background: linear-gradient(0deg,
                    rgba(20,20,20,0.9) 0%,
                    rgba(10,10,10,0.85) 100%);
                border-top: 1px solid rgba(255,255,255,0.1);
                box-shadow: 0 -3px 20px rgba(0,0,0,0.8);
                z-index: 100;
            }

            .footer-btn {
                padding: 6px 8px;
                font-size: 0.6rem;
                letter-spacing: 1px;
                background: transparent;
                box-shadow: none;
                border-right: 1px solid rgba(255,255,255,0.1);
            }

            .footer-btn:last-child {
                border-right: none;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="round-container">
            <span class="round-label">Round</span>
            <span class="round-value" id="round">1</span>
            <div class="round-clickable">
                <div class="round-zone" onclick="changeRound(-1)">
                    <span class="round-zone-indicator">&lt;</span>
                </div>
                <div class="round-zone" onclick="changeRound(1)">
                    <span class="round-zone-indicator">&gt;</span>
                </div>
            </div>
        </div>
    </header>

    <main class="scores-container">
        <section class="player-side defender-side" id="defender-side">
            <div class="score-section vp-section">
                <span class="score-label">Defender VP</span>
                <span class="score-value" id="defender-vp">0</span>
                <div class="score-clickable">
                    <div class="click-zone decrease" onclick="changeScore('defender', 'vp', -1)">
                        <span class="click-zone-indicator">&lt;</span>
                    </div>
                    <div class="click-zone increase" onclick="changeScore('defender', 'vp', 1)">
                        <span class="click-zone-indicator">&gt;</span>
                    </div>
                </div>
            </div>
            <div class="score-section cp-section">
                <span class="score-label">Defender CP</span>
                <span class="score-value" id="defender-cp">0</span>
                <div class="score-clickable">
                    <div class="click-zone decrease" onclick="changeScore('defender', 'cp', -1)">
                        <span class="click-zone-indicator">&lt;</span>
                    </div>
                    <div class="click-zone increase" onclick="changeScore('defender', 'cp', 1)">
                        <span class="click-zone-indicator">&gt;</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="player-side attacker-side" id="attacker-side">
            <div class="score-section vp-section">
                <span class="score-label">Attacker VP</span>
                <span class="score-value" id="attacker-vp">0</span>
                <div class="score-clickable">
                    <div class="click-zone decrease" onclick="changeScore('attacker', 'vp', -1)">
                        <span class="click-zone-indicator">&lt;</span>
                    </div>
                    <div class="click-zone increase" onclick="changeScore('attacker', 'vp', 1)">
                        <span class="click-zone-indicator">&gt;</span>
                    </div>
                </div>
            </div>
            <div class="score-section cp-section">
                <span class="score-label">Attacker CP</span>
                <span class="score-value" id="attacker-cp">0</span>
                <div class="score-clickable">
                    <div class="click-zone decrease" onclick="changeScore('attacker', 'cp', -1)">
                        <span class="click-zone-indicator">&lt;</span>
                    </div>
                    <div class="click-zone increase" onclick="changeScore('attacker', 'cp', 1)">
                        <span class="click-zone-indicator">&gt;</span>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <button class="footer-btn" onclick="switchSides()">Switch Sides</button>
        <button class="footer-btn" onclick="showResetConfirm()">Reset</button>
    </footer>

    <!-- Fullscreen button -->
    <button class="fullscreen-btn" onclick="toggleFullscreen()">FS</button>

    <!-- Reset Confirmation Modal -->
    <div class="modal-overlay" id="resetModal">
        <div class="modal">
            <h2>Reset Game?</h2>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="hideResetConfirm()">Cancel</button>
                <button class="modal-btn confirm" onclick="confirmReset()">Reset</button>
            </div>
        </div>
    </div>

    <!-- iOS Fullscreen Instructions Modal -->
    <div class="modal-overlay" id="iosModal">
        <div class="modal">
            <h2>Fullscreen on iOS</h2>
            <p style="color: #888; margin-bottom: 20px; font-size: 0.9rem; line-height: 1.5;">
                iOS doesn't support fullscreen.<br>
                To get fullscreen, add this app to your home screen:
            </p>
            <ol style="color: #aaa; text-align: left; font-size: 0.8rem; line-height: 1.8; margin-bottom: 25px;">
                <li>Tap the Share button (square with arrow)</li>
                <li>Scroll down and tap "Add to Home Screen"</li>
                <li>Tap "Add"</li>
                <li>Open the app from your home screen</li>
            </ol>
            <button class="modal-btn cancel" onclick="hideIosModal()">OK</button>
        </div>
    </div>

    <script>
        // Game state
        let state = {
            attacker: { vp: 0, cp: 0 },
            defender: { vp: 0, cp: 0 },
            round: 1,
            switched: false
        };

        // Load state from localStorage
        function loadState() {
            const saved = localStorage.getItem('40k-score-tracker');
            if (saved) {
                try {
                    state = JSON.parse(saved);
                } catch (e) {
                    console.log('Could not load saved state');
                }
            }
        }

        // Save state to localStorage
        function saveState() {
            localStorage.setItem('40k-score-tracker', JSON.stringify(state));
        }

        // Haptic feedback
        function vibrate() {
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        // Update display
        function updateDisplay() {
            document.getElementById('attacker-vp').textContent = state.attacker.vp;
            document.getElementById('attacker-cp').textContent = state.attacker.cp;
            document.getElementById('defender-vp').textContent = state.defender.vp;
            document.getElementById('defender-cp').textContent = state.defender.cp;
            document.getElementById('round').textContent = state.round;

            // Apply switched state
            const defenderSide = document.getElementById('defender-side');
            const attackerSide = document.getElementById('attacker-side');
            if (state.switched) {
                defenderSide.style.order = '2';
                attackerSide.style.order = '1';
            } else {
                defenderSide.style.order = '1';
                attackerSide.style.order = '2';
            }

            saveState();
        }

        // Track consecutive presses
        const tapTrackers = {};

        // Show tap indicator with consecutive counting
        function showTapIndicator(player, type, delta) {
            const key = `${player}-${type}-${delta > 0 ? 'plus' : 'minus'}`;
            const section = document.querySelector(`#${player}-side .${type}-section`);

            // Check if there's an active indicator for this key
            if (tapTrackers[key] && tapTrackers[key].active) {
                // Update existing indicator
                tapTrackers[key].count += Math.abs(delta);
                const indicator = tapTrackers[key].element;
                indicator.textContent = delta > 0 ? `+${tapTrackers[key].count}` : `-${tapTrackers[key].count}`;

                // Reset the fade timer
                clearTimeout(tapTrackers[key].fadeTimer);
                clearTimeout(tapTrackers[key].removeTimer);

                tapTrackers[key].fadeTimer = setTimeout(() => {
                    indicator.classList.add('fade');
                    tapTrackers[key].removeTimer = setTimeout(() => {
                        indicator.remove();
                        tapTrackers[key].active = false;
                    }, 400);
                }, 1200);
            } else {
                // Create new indicator
                const indicator = document.createElement('div');
                indicator.className = `tap-indicator ${delta > 0 ? 'plus' : 'minus'}`;
                indicator.textContent = delta > 0 ? `+1` : `-1`;
                indicator.style.left = '50%';
                indicator.style.top = '50%';
                indicator.style.transform = 'translate(-50%, -50%)';
                section.appendChild(indicator);

                tapTrackers[key] = {
                    active: true,
                    count: 1,
                    element: indicator,
                    fadeTimer: null,
                    removeTimer: null
                };

                // Trigger animation
                requestAnimationFrame(() => {
                    indicator.classList.add('show');
                    tapTrackers[key].fadeTimer = setTimeout(() => {
                        indicator.classList.add('fade');
                        tapTrackers[key].removeTimer = setTimeout(() => {
                            indicator.remove();
                            tapTrackers[key].active = false;
                        }, 400);
                    }, 1200);
                });
            }
        }

        // Change score
        function changeScore(player, type, delta) {
            vibrate();
            state[player][type] += delta;
            showTapIndicator(player, type, delta);
            updateDisplay();
        }

        // Change round
        function changeRound(delta) {
            vibrate();
            const newRound = state.round + delta;
            if (newRound >= 1) {
                state.round = newRound;
                updateDisplay();
            }
        }

        // Show reset confirmation
        function showResetConfirm() {
            vibrate();
            document.getElementById('resetModal').classList.add('active');
        }

        // Hide reset confirmation
        function hideResetConfirm() {
            vibrate();
            document.getElementById('resetModal').classList.remove('active');
        }

        // Confirm reset
        function confirmReset() {
            vibrate();
            state.attacker.vp = 0;
            state.attacker.cp = 0;
            state.defender.vp = 0;
            state.defender.cp = 0;
            state.round = 1;
            state.switched = false;
            updateDisplay();
            hideResetConfirm();
        }

        // Switch sides (swap positions)
        function switchSides() {
            vibrate();
            state.switched = !state.switched;
            updateDisplay();
        }

        // Detect iOS
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
            (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

        // Check if running as standalone PWA
        const isStandalone = window.navigator.standalone ||
            window.matchMedia('(display-mode: standalone)').matches;

        // Show iOS modal
        function showIosModal() {
            document.getElementById('iosModal').classList.add('active');
        }

        // Hide iOS modal
        function hideIosModal() {
            vibrate();
            document.getElementById('iosModal').classList.remove('active');
        }

        // Toggle fullscreen
        function toggleFullscreen() {
            vibrate();

            // If iOS and not standalone, show instructions
            if (isIOS && !isStandalone) {
                showIosModal();
                return;
            }

            // If already standalone on iOS, hide the button
            if (isIOS && isStandalone) {
                return;
            }

            const elem = document.documentElement;

            const isFullscreen = document.fullscreenElement ||
                document.webkitFullscreenElement ||
                document.mozFullScreenElement ||
                document.msFullscreenElement;

            if (!isFullscreen) {
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.mozRequestFullScreen) {
                    elem.mozRequestFullScreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        }

        // Hide fullscreen button if already in standalone mode
        if (isStandalone) {
            document.querySelector('.fullscreen-btn').style.display = 'none';
        }

        // Update fullscreen button text
        function updateFullscreenBtn() {
            const btn = document.querySelector('.fullscreen-btn');
            const isFullscreen = document.fullscreenElement ||
                document.webkitFullscreenElement ||
                document.mozFullScreenElement ||
                document.msFullscreenElement;
            if (btn) {
                btn.textContent = isFullscreen ? 'X' : 'FS';
            }
        }

        document.addEventListener('fullscreenchange', updateFullscreenBtn);
        document.addEventListener('webkitfullscreenchange', updateFullscreenBtn);
        document.addEventListener('mozfullscreenchange', updateFullscreenBtn);
        document.addEventListener('MSFullscreenChange', updateFullscreenBtn);

        // Initialize
        loadState();
        updateDisplay();
    </script>
</body>
</html>
